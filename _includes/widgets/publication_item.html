{% assign show_abs = include.show_abstract %}
{% if show_abs == nil %}
  {% assign show_abs = true %}
{% endif %}

{% assign show_links = include.show_links %}
{% if show_links == nil %}
  {% assign show_links = true %}
{% endif %}

{% assign item = include.item %}

<style>
  /* Publications 项目式按钮（与 Projects 风格一致的小按钮） */
  .pub-links {
    display: flex;
    flex-wrap: wrap;
    gap: .5rem;
    padding: .5rem 0 .25rem;
  }
  .pub-links .btn {
    padding: .25rem .5rem;
    font-size: .8rem;
    border-radius: .5rem;
  }
</style>

{%- comment -%}
  将 item.links 转为按钮的辅助片段：
  - 根据键名（不区分大小写）猜测按钮类别与图标/颜色
  - 兼容 link: { url: "...", target: "..."} 或 link: "..."
  - 对 DOI 支持裸 DOI（自动加 https://doi.org/）
{%- endcomment -%}
{% capture render_link_buttons %}
  {% if item.links %}
    {% for link in item.links %}
      {% assign key_raw = link[0] %}
      {% assign key = key_raw | downcase %}
      {% if link[1].url %}
        {% assign url = link[1].url %}
        {% assign target = link[1].target | default: '_blank' %}
      {% else %}
        {% assign url = link[1] %}
        {% assign target = '_blank' %}
      {% endif %}

      {%- comment -%} 归一化 DOI URL {%- endcomment -%}
      {% assign is_doi = false %}
      {% if key contains 'doi' %}
        {% assign is_doi = true %}
      {% endif %}
      {% if is_doi and url and (url contains 'http' ) == false %}
        {% assign url = 'https://doi.org/' | append: url %}
      {% endif %}

      {%- comment -%} 按键名匹配视觉风格与标签 {%- endcomment -%}
      {% assign btn_class = 'btn-outline-secondary' %}
      {% assign icon = 'fas fa-external-link-alt' %}
      {% assign label = key_raw %}

      {% if key == 'paper' or key contains 'pdf' %}
        {% assign btn_class = 'btn-outline-primary' %}
        {% assign icon = 'fas fa-file-alt' %}
        {% assign label = 'Paper' %}
      {% elsif key contains 'code' or key contains 'github' %}
        {% assign btn_class = 'btn-outline-secondary' %}
        {% assign icon = 'fab fa-github' %}
        {% assign label = 'Code' %}
      {% elsif key contains 'slide' or key contains 'ppt' %}
        {% assign btn_class = 'btn-outline-info' %}
        {% assign icon = 'fas fa-file-powerpoint' %}
        {% assign label = 'Slides' %}
      {% elsif key contains 'poster' %}
        {% assign btn_class = 'btn-outline-info' %}
        {% assign icon = 'fas fa-image' %}
        {% assign label = 'Poster' %}
      {% elsif key contains 'video' or key contains 'talk' or key contains 'record' or key contains 'youtube' %}
        {% assign btn_class = 'btn-outline-danger' %}
        {% assign icon = 'fas fa-video' %}
        {% assign label = 'Video' %}
      {% elsif key contains 'data' or key contains 'dataset' %}
        {% assign btn_class = 'btn-outline-success' %}
        {% assign icon = 'fas fa-database' %}
        {% assign label = 'Dataset' %}
      {% elsif key contains 'arxiv' %}
        {% assign btn_class = 'btn-outline-dark' %}
        {% assign icon = 'fas fa-external-link-alt' %}
        {% assign label = 'arXiv' %}
      {% elsif is_doi %}
        {% assign btn_class = 'btn-outline-dark' %}
        {% assign icon = 'fas fa-link' %}
        {% assign label = 'DOI' %}
      {% elsif key contains 'project' or key contains 'website' or key == 'page' or key contains 'demo' %}
        {% assign btn_class = 'btn-outline-secondary' %}
        {% assign icon = 'fas fa-external-link-alt' %}
        {% assign label = 'Website' %}
      {% elsif key contains 'bib' %}
        {% assign btn_class = 'btn-outline-secondary' %}
        {% assign icon = 'fas fa-book' %}
        {% assign label = 'BibTeX' %}
      {% endif %}

      {% if url %}
        <a class="btn {{ btn_class }} btn-sm" href="{{ url | relative_url }}" target="{{ target }}" rel="noopener">
          <i class="{{ icon }}"></i> {{ label }}
        </a>
      {% endif %}
    {% endfor %}
  {% endif %}
{% endcapture %}

<div class="d-none d-md-block">
  <div class="row no-gutters {% unless include.hide_bottom_border %}border-bottom{% endunless %} border-gray">
    <div class="col-md-3 col-xl-2 mb-md-0 p-md-3">
      {%- if item.cover -%}
      <img data-src="{{ item.cover | relative_url }}" alt="{{ item.title }}" class="lazy w-100 rounded-sm" src="{{ '/assets/images/empty_300x200.png' | relative_url }}">
      {%- else -%}
      <svg class="bubble-visual-hash lazy w-100 rounded-sm" data-bubble-visual-hash="{{ item.id }}" viewBox="0 0 300 200"></svg>
      {%- endif -%}
    </div>
    <div class="col-md-9 col-xl-10 p-3 pl-md-0">
      <h5 class="mt-0 mb-1 font-weight-normal">{{ item.title }}</h5>
      <p class="mt-0 mb-0 small">{% include widgets/author_list.html authors=item.authors %}</p>
      <p class="mt-0 mb-0 small">{{item.pub_pre}}<i>{{ item.pub }}</i>{{ item.pub_post }} {{ item.pub_date }} {{ item.pub_last }} <span data-semantic-schol ar-id="{{ item.semantic_scholar_id }}"></span></p>
      {% if show_abs and item.abstract %}
      <p class="mt-0 mb-0 small text-muted">{{ item.abstract }}</p>
      {% endif %}

      <!-- 原有的方括号文本链接，保留 -->
      <p class="small pb-0 mb-0 lh-125 text-muted abstract-links">
        {% for link in item.links %}
          {% if link[1].url %}
            <a target="{{ link[1]['target'] | default: '_blank' }}" href="{{ link[1]['url'] }}">[{{ link[0] }}]</a>
          {% else %}
            <a target="_blank" href="{{ link[1] }}">[{{ link[0] }}]</a>
          {% endif %}
        {% endfor %}
      </p>

      {% if show_links %}
        {%- assign _paper = item.paper | default: item.pdf -%}
        {%- assign _code = item.code | default: item.github -%}
        {%- assign _dataset = item.dataset | default: item.data -%}
        {%- assign _site = item.website | default: item.page | default: item.project -%}
        <div class="pub-links">
          {%- if _paper -%}
            <a class="btn btn-outline-primary btn-sm" href="{{ _paper | relative_url }}" target="_blank" rel="noopener">
              <i class="fas fa-file-alt"></i> Paper
            </a>
          {%- endif -%}
          {%- if _code -%}
            <a class="btn btn-outline-secondary btn-sm" href="{{ _code | relative_url }}" target="_blank" rel="noopener">
              <i class="fab fa-github"></i> Code
            </a>
          {%- endif -%}
          {%- if item.slides -%}
            <a class="btn btn-outline-info btn-sm" href="{{ item.slides | relative_url }}" target="_blank" rel="noopener">
              <i class="fas fa-file-powerpoint"></i> Slides
            </a>
          {%- endif -%}
          {%- if item.poster -%}
            <a class="btn btn-outline-info btn-sm" href="{{ item.poster | relative_url }}" target="_blank" rel="noopener">
              <i class="fas fa-image"></i> Poster
            </a>
          {%- endif -%}
          {%- if item.video -%}
            <a class="btn btn-outline-danger btn-sm" href="{{ item.video | relative_url }}" target="_blank" rel="noopener">
              <i class="fas fa-video"></i> Video
            </a>
          {%- endif -%}
          {%- if _dataset -%}
            <a class="btn btn-outline-success btn-sm" href="{{ _dataset | relative_url }}" target="_blank" rel="noopener">
              <i class="fas fa-database"></i> Dataset
            </a>
          {%- endif -%}
          {%- if item.arxiv -%}
            <a class="btn btn-outline-dark btn-sm" href="{{ item.arxiv }}" target="_blank" rel="noopener">
              <i class="fas fa-external-link-alt"></i> arXiv
            </a>
          {%- endif -%}
          {%- if item.doi -%}
            <a class="btn btn-outline-dark btn-sm" href="https://doi.org/{{ item.doi }}" target="_blank" rel="noopener">
              <i class="fas fa-link"></i> DOI
            </a>
          {%- endif -%}
          {%- if _site -%}
            <a class="btn btn-outline-secondary btn-sm" href="{{ _site | relative_url }}" target="_blank" rel="noopener">
              <i class="fas fa-external-link-alt"></i> Website
            </a>
          {%- endif -%}
          {{ render_link_buttons }}
        </div>
      {% endif %}
    </div>
  </div>
</div>

<div class="row no-gutters d-md-none {% unless include.hide_bottom_border %}border-bottom{% endunless %} border-gray {% if include.first %}rounded-xl-top{% endif %} {% if include.last %}rounded-xl-bottom{% endif %} {% if item.cover %}lazy{% endif %}" data-src="{{ item.cover | relative_url }}">
  <div class="w-100 {% if include.first %}rounded-xl-top{% endif %} {% if include.last %}rounded-xl-bottom{% endif %}" style="background-color: rgba(255,255,255,0.9);">
    <div class="d-flex align-items-start flex-column py-3 px-4">
      <div class="mb-auto"></div>
      <div>
        <h5 class="mt-0 mb-1 font-weight-normal">{{ item.title }}</h5>
        <p class="mt-0 mb-0 small">{% include widgets/author_list.html authors=item.authors %}</p>
        <p class="mt-0 mb-0 small">{{item.pub_pre}}<i>{{ item.pub }}</i>{{ item.pub_post }} {{ item.pub_date }} {{ item.pub_last }} <span data-semantic-scholar-id="{{ item.semantic_scholar_id }}"></span></p>
        {% if show_abs and item.abstract %}
        <p class="mt-0 mb-0 small text-muted">{{ item.abstract }}</p>
        {% endif %}

        <!-- 原有的方括号文本链接，保留 -->
        <p class="small pb-0 mb-0 lh-125 text-muted abstract-links">
          {% for link in item.links %}
            {% if link[1].url %}
              <a target="{{ link[1]['target'] | default: '_blank' }}" href="{{ link[1]['url'] }}">[{{ link[0] }}]</a>
            {% else %}
              <a target="_blank" href="{{ link[1] }}">[{{ link[0] }}]</a>
            {% endif %}
          {% endfor %}
        </p>

        {% if show_links %}
          {%- assign _paper = item.paper | default: item.pdf -%}
          {%- assign _code = item.code | default: item.github -%}
          {%- assign _dataset = item.dataset | default: item.data -%}
          {%- assign _site = item.website | default: item.page | default: item.project -%}
          <div class="pub-links">
            {%- if _paper -%}
              <a class="btn btn-outline-primary btn-sm" href="{{ _paper | relative_url }}" target="_blank" rel="noopener">
                <i class="fas fa-file-alt"></i> Paper
              </a>
            {%- endif -%}
            {%- if _code -%}
              <a class="btn btn-outline-secondary btn-sm" href="{{ _code | relative_url }}" target="_blank" rel="noopener">
                <i class="fab fa-github"></i> Code
              </a>
            {%- endif -%}
            {%- if item.slides -%}
              <a class="btn btn-outline-info btn-sm" href="{{ item.slides | relative_url }}" target="_blank" rel="noopener">
                <i class="fas fa-file-powerpoint"></i> Slides
              </a>
            {%- endif -%}
            {%- if item.poster -%}
              <a class="btn btn-outline-info btn-sm" href="{{ item.poster | relative_url }}" target="_blank" rel="noopener">
                <i class="fas fa-image"></i> Poster
              </a>
            {%- endif -%}
            {%- if item.video -%}
              <a class="btn btn-outline-danger btn-sm" href="{{ item.video | relative_url }}" target="_blank" rel="noopener">
                <i class="fas fa-video"></i> Video
              </a>
            {%- endif -%}
            {%- if _dataset -%}
              <a class="btn btn-outline-success btn-sm" href="{{ _dataset | relative_url }}" target="_blank" rel="noopener">
                <i class="fas fa-database"></i> Dataset
              </a>
            {%- endif -%}
            {%- if item.arxiv -%}
              <a class="btn btn-outline-dark btn-sm" href="{{ item.arxiv }}" target="_blank" rel="noopener">
                <i class="fas fa-external-link-alt"></i> arXiv
              </a>
            {%- endif -%}
            {%- if item.doi -%}
              <a class="btn btn-outline-dark btn-sm" href="https://doi.org/{{ item.doi }}" target="_blank" rel="noopener">
                <i class="fas fa-link"></i> DOI
              </a>
            {%- endif -%}
            {%- if _site -%}
              <a class="btn btn-outline-secondary btn-sm" href="{{ _site | relative_url }}" target="_blank" rel="noopener">
                <i class="fas fa-external-link-alt"></i> Website
              </a>
            {%- endif -%}
            {{ render_link_buttons }}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
