{% assign show_abs = include.show_abstract %}
{% if show_abs == nil %}
  {% assign show_abs = true %}
{% endif %}

{% assign show_links = include.show_links %}
{% if show_links == nil %}
  {% assign show_links = true %}
{% endif %}

{% assign item = include.item %}

/* ------------------ 小工具：生成“有效链接”的文本与按钮 HTML ------------------ */
{% capture _valid_text_links %}{% endcapture %}
{% capture _valid_btn_links %}{% endcapture %}

{%- comment -%}
  工具：输出一个按钮（Bootstrap outline 风格的小按钮）
{%- endcomment -%}
{% assign _btn_tpl = '<a class="btn BTNCLASS btn-sm" href="URL" target="TARGET" rel="noopener"><i class="ICON"></i> LABEL</a>' %}

{%- comment -%}
  工具：根据键名决定按钮风格与标签
{%- endcomment -%}
{% assign _map = '
paper|btn-outline-primary|fas fa-file-alt|Paper,
pdf|btn-outline-primary|fas fa-file-alt|Paper,
code|btn-outline-secondary|fab fa-github|Code,
github|btn-outline-secondary|fab fa-github|Code,
slides|btn-outline-info|fas fa-file-powerpoint|Slides,
ppt|btn-outline-info|fas fa-file-powerpoint|Slides,
poster|btn-outline-info|fas fa-image|Poster,
video|btn-outline-danger|fas fa-video|Video,
record|btn-outline-danger|fas fa-video|Video,
dataset|btn-outline-success|fas fa-database|Dataset,
data|btn-outline-success|fas fa-database|Dataset,
arxiv|btn-outline-dark|fas fa-external-link-alt|arXiv,
doi|btn-outline-dark|fas fa-link|DOI,
website|btn-outline-secondary|fas fa-external-link-alt|Website,
page|btn-outline-secondary|fas fa-external-link-alt|Website,
project|btn-outline-secondary|fas fa-external-link-alt|Website,
bib|btn-outline-secondary|fas fa-book|BibTeX,
bibtex|btn-outline-secondary|fas fa-book|BibTeX
' | strip %}

{% assign _printed_urls = '' %}

{%- comment -%}
  判断 URL 是否有效（排除空、#、N/A、TBD、coming soon、-、—）
{%- endcomment -%}
{% assign _bad_tokens = '#,/#,n/a,na,tbd,coming soon,-,—' | downcase %}

{%- comment -%}
  帮助函数：尝试渲染一条链接（文本 + 按钮），仅当 URL 有效且未重复
{%- endcomment -%}
{% macro _emit_for key_raw url_raw target_raw %}
  {% assign key = key_raw | downcase %}
  {% assign url = url_raw | to_s | strip %}
  {% assign target = target_raw | default: '_blank' %}

  {% assign url_dc = url | downcase %}
  {% assign is_bad = false %}
  {% if url == '' %}{% assign is_bad = true %}{% endif %}
  {% if _bad_tokens contains url_dc %}{% assign is_bad = true %}{% endif %}
  {% if is_bad %}{% return %}{% endif %}

  {# 裸 DOI 自动补全 #}
  {% if key == 'doi' and url and (url contains 'http') == false %}
    {% assign url = 'https://doi.org/' | append: url %}
    {% assign url_dc = url | downcase %}
  {% endif %}

  {# 避免重复 #}
  {% if _printed_urls contains url_dc %}{% return %}{% endif %}
  {% assign _printed_urls = _printed_urls | append: url_dc | append: '|' %}

  {# 文本链接（原有方括号风格） #}
  {% capture _valid_text_links %}{{ _valid_text_links }}<a target="{{ target }}" href="{{ url }}">[{{ key_raw }}]</a> {% endcapture %}

  {# 按钮映射 #}
  {% assign btn_class = 'btn-outline-secondary' %}
  {% assign icon = 'fas fa-external-link-alt' %}
  {% assign label = key_raw %}
  {% assign found = '' %}
  {% assign pairs = _map | split: ',' %}
  {% for p in pairs %}
    {% assign parts = p | split: '|' %}
    {% assign kk = parts[0] | strip %}
    {% if kk == key %}
      {% assign found = p %}
      {% break %}
    {% endif %}
  {% endfor %}
  {% if found != '' %}
    {% assign parts = found | split: '|' %}
    {% assign btn_class = parts[1] | strip %}
    {% assign icon = parts[2] | strip %}
    {% assign label = parts[3] | strip %}
  {% endif %}

  {% assign _btn = _btn_tpl
    | replace: 'BTNCLASS', btn_class
    | replace: 'URL', url
    | replace: 'TARGET', target
    | replace: 'ICON', icon
    | replace: 'LABEL', label %}

  {% capture _valid_btn_links %}{{ _valid_btn_links }}{{ _btn }} {% endcapture %}
{% endmacro %}

{%- comment -%}
  先处理“独立字段”来源
{%- endcomment -%}
{% if item.paper %}{{ '' | _emit_for: 'paper', item.paper, '_blank' }}{% endif %}
{% if item.pdf %}{{ '' | _emit_for: 'pdf', item.pdf, '_blank' }}{% endif %}
{% if item.code %}{{ '' | _emit_for: 'code', item.code, '_blank' }}{% endif %}
{% if item.github %}{{ '' | _emit_for: 'github', item.github, '_blank' }}{% endif %}
{% if item.slides %}{{ '' | _emit_for: 'slides', item.slides, '_blank' }}{% endif %}
{% if item.poster %}{{ '' | _emit_for: 'poster', item.poster, '_blank' }}{% endif %}
{% if item.video %}{{ '' | _emit_for: 'video', item.video, '_blank' }}{% endif %}
{% if item.dataset %}{{ '' | _emit_for: 'dataset', item.dataset, '_blank' }}{% endif %}
{% if item.data %}{{ '' | _emit_for: 'data', item.data, '_blank' }}{% endif %}
{% if item.arxiv %}{{ '' | _emit_for: 'arxiv', item.arxiv, '_blank' }}{% endif %}
{% if item.doi %}{{ '' | _emit_for: 'doi', item.doi, '_blank' }}{% endif %}
{% if item.website %}{{ '' | _emit_for: 'website', item.website, '_blank' }}{% endif %}
{% if item.page %}{{ '' | _emit_for: 'page', item.page, '_blank' }}{% endif %}
{% if item.project %}{{ '' | _emit_for: 'project', item.project, '_blank' }}{% endif %}
{% if item.bibtex %}{{ '' | _emit_for: 'bibtex', item.bibtex, '_blank' }}{% endif %}

{%- comment -%}
  再处理 item.links（键名自动映射）
{%- endcomment -%}
{% if item.links %}
  {% for link in item.links %}
    {% assign key_raw = link[0] %}
    {% if link[1].url %}
      {% assign url_val = link[1].url %}
      {% assign target_val = link[1].target | default: '_blank' %}
    {% else %}
      {% assign url_val = link[1] %}
      {% assign target_val = '_blank' %}
    {% endif %}
    {{ '' | _emit_for: key_raw, url_val, target_val }}
  {% endfor %}
{% endif %}

/* ------------------ 版式：桌面端 ------------------ */
<div class="d-none d-md-block">
  <div class="row no-gutters {% unless include.hide_bottom_border %}border-bottom{% endunless %} border-gray">
    <div class="col-md-3 col-xl-2 mb-md-0 p-md-3">
      {%- if item.cover -%}
      <img data-src="{{ item.cover | relative_url }}" alt="{{ item.title }}" class="lazy w-100 rounded-sm" src="{{ '/assets/images/empty_300x200.png' | relative_url }}">
      {%- else -%}
      <svg class="bubble-visual-hash lazy w-100 rounded-sm" data-bubble-visual-hash="{{ item.id }}" viewBox="0 0 300 200"></svg>
      {%- endif -%}
    </div>
    <div class="col-md-9 col-xl-10 p-3 pl-md-0">
      <h5 class="mt-0 mb-1 font-weight-normal">{{ item.title }}</h5>
      <p class="mt-0 mb-0 small">{% include widgets/author_list.html authors=item.authors %}</p>
      <p class="mt-0 mb-0 small">{{item.pub_pre}}<i>{{ item.pub }}</i>{{ item.pub_post }} {{ item.pub_date }} {{ item.pub_last }} <span data-semantic-scholar-id="{{ item.semantic_scholar_id }}"></span></p>

      {% if show_abs and item.abstract %}
      <p class="mt-0 mb-0 small text-muted">{{ item.abstract }}</p>
      {% endif %}

      {# 仅当有有效文本链接时才显示原“方括号”行 #}
      {% assign _text_strip = _valid_text_links | strip %}
      {% if _text_strip != '' %}
        <p class="small pb-0 mb-0 lh-125 text-muted abstract-links">
          {{ _valid_text_links }}
        </p>
      {% endif %}

      {# 仅当开启且确有可展示按钮时才显示按钮区 #}
      {% if show_links %}
        {% assign _btn_strip = _valid_btn_links | strip %}
        {% if _btn_strip != '' %}
          <div class="project-links" style="padding:.5rem 0 .25rem;">
            {{ _valid_btn_links }}
          </div>
        {% endif %}
      {% endif %}

    </div>
  </div>
</div>

<!-- ------------------ 版式：移动端 ------------------ -->
<div class="row no-gutters d-md-none {% unless include.hide_bottom_border %}border-bottom{% endunless %} border-gray {% if include.first %}rounded-xl-top{% endif %} {% if include.last %}rounded-xl-bottom{% endif %} {% if item.cover %}lazy{% endif %}" data-src="{{ item.cover | relative_url }}">
  <div class="w-100 {% if include.first %}rounded-xl-top{% endif %} {% if include.last %}rounded-xl-bottom{% endif %}" style="background-color: rgba(255,255,255,0.9);">
    <div class="d-flex align-items-start flex-column py-3 px-4">
      <div class="mb-auto"></div>
      <div>
        <h5 class="mt-0 mb-1 font-weight-normal">{{ item.title }}</h5>
        <p class="mt-0 mb-0 small">{% include widgets/author_list.html authors=item.authors %}</p>
        <p class="mt-0 mb-0 small">{{item.pub_pre}}<i>{{ item.pub }}</i>{{ item.pub_post }} {{ item.pub_date }} {{ item.pub_last }} <span data-semantic-scholar-id="{{ item.semantic_scholar_id }}"></span></p>

        {% if show_abs and item.abstract %}
        <p class="mt-0 mb-0 small text-muted">{{ item.abstract }}</p>
        {% endif %}

        {% assign _text_strip_m = _valid_text_links | strip %}
        {% if _text_strip_m != '' %}
          <p class="small pb-0 mb-0 lh-125 text-muted abstract-links">
            {{ _valid_text_links }}
          </p>
        {% endif %}

        {% if show_links %}
          {% assign _btn_strip_m = _valid_btn_links | strip %}
          {% if _btn_strip_m != '' %}
            <div class="project-links" style="padding:.5rem 0 .25rem;">
              {{ _valid_btn_links }}
            </div>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
</div>
